{
  "ministère": "République\ndes Devs :)",
  "nomService": "Mon tuto point com",
  "body": "# Tutoriel: Storage S3 sur Clevercloud (avec docker)\r\n\r\n### Objectif: Avoir un storage S3 (Standard du stockage en ligne, origine de amazon mais plus dépendent du service).\r\n\r\nHébergeur : \r\n\r\n[Home - Clever Cloud](https://www.clever-cloud.com)\r\n\r\nau travers d’un service Cellar qui permet d’avoir des buckets s3 :\r\n\r\n[](https://www.clever-cloud.com/cellar-s3-hosting/)\r\n\r\nAvantages :\r\n\r\n- il est possible simple avec un simple token api et leur ligne de commande d’avoir le service monté en quelques minutes.\r\n- c’est automatisable et reproductible rapidement (une fois toutes les variables d’environement récupérées)\r\n- Les prix sont cohérents\r\n\r\n## Prérequis:\r\n\r\n- Avoir un compte clevercloud payant\r\n- Avoir docker installé sur son poste de travail\r\n\r\n## 1. Récupérer les variables d'environnement CLEVER_TOKEN et CLEVER_SECRET pour la cli\r\n\r\nOn utilise l’image docker `clevercloud/clever-tools` (sans installation de la cli clevercloud en local)\r\n\r\n### a. Executez la commande suivante pour obtenir une url de connexion :\r\n\r\n```bash\r\ndocker run clevercloud/clever-tools login\r\n```\r\n\r\n![clever_login_url.png](Tutoriel%20Storage%20S3%20sur%20Clevercloud%20(avec%20docker)%2069441023853044deb9226465cc21941a/clever_login_url.png)\r\n\r\n### b. Collez l’url dans votre navigateur puis connectez vous à votre compte clevercloud\r\n\r\nLa page suivante apparait :\r\n\r\n![clever_login.png](Tutoriel%20Storage%20S3%20sur%20Clevercloud%20(avec%20docker)%2069441023853044deb9226465cc21941a/clever_login.png)\r\n\r\n### c. Récupérez CLEVER_TOKEN et CLEVER_SECRET\r\n\r\n## 2. Créer l'addon Cellar (c’est à dire le S3 clever cloud) en pas à pas\r\n\r\n### a. Tester l'appel à la cli\r\n\r\nEn passant les tokens récupérés à l'étape précédente à l'image docker vous pouvez tester la cli rapidement :\r\n\r\n```bash\r\ndocker run --env CLEVER_TOKEN=TOKEN_VALUE --env CLEVER_SECRET=SECRET_VALUE clevercloud/clever-tools --help\r\n```\r\n\r\n![clever_test_cli.png](Tutoriel%20Storage%20S3%20sur%20Clevercloud%20(avec%20docker)%2069441023853044deb9226465cc21941a/clever_test_cli.png)\r\n\r\n### b. Quelques commandes utiles\r\n\r\n### Lister les addons providers\r\n\r\n:warning: Cette commande doit être executée sans les variables d'authentification\r\n\r\n```bash\r\n docker run clevercloud/clever-tools addon providers\r\n\r\n```\r\n\r\n![clever_list_addons.png](Tutoriel%20Storage%20S3%20sur%20Clevercloud%20(avec%20docker)%2069441023853044deb9226465cc21941a/clever_list_addons.png)\r\n\r\n### Lister les plan d'un addon\r\n\r\n```bash\r\ndocker run clevercloud/clever-tools addon providers show cellar-addon\r\n\r\n```\r\n\r\n![clever_list_addon_plan.png](Tutoriel%20Storage%20S3%20sur%20Clevercloud%20(avec%20docker)%2069441023853044deb9226465cc21941a/clever_list_addon_plan.png)\r\n\r\n### c. Créer l’addon cellar\r\n\r\n```bash\r\ndocker run --env CLEVER_TOKEN=TOKEN_VALUE --env CLEVER_SECRET=CLEVER_SECRET clevercloud/clever-tools addon create cellar-addon mycellar --plan S\r\n\r\n```\r\n\r\n## 3. Créer un bucket sur l'addon cellar\r\n\r\nNote: Nous allons utiliser la CLI AWS mais cela ne passe pas par les serveurs AWS (c’est juste un outil).\r\n\r\n### Outil de manipulation cli\r\n\r\nNous avons besoin d'un outil pour manipuler les configurations des buckets.\r\n\r\nPour faciliter un déploiement automatisé et une possibilité d'architecture nous allons utiliser dans ce tutoriel la cli aws via docker pour gérer les buckets eux-mêmes. La liste des autres options (s3cmd | AWS Sdk) est disponible ici : [https://www.clever-cloud.com/doc/deploy/addon/cellar/](https://www.clever-cloud.com/doc/deploy/addon/cellar/)\r\nLa configuration des s3 se manipule via la cli aws.\r\n\r\n```bash\r\ndocker pull amazon/aws-cli\r\n```\r\n\r\n### Prérequis: Récupérer les variables d'environnement pour la cli aws\r\n\r\n1. Récupérer les secrets sur la console [https://console.clever-cloud.com](https://console.clever-cloud.com/)\r\n`Addons > Votre addon Cellar > Informations > Variables d'environnement`\r\n(Pas trouvé de moyen de récupérer en cli les valeurs des variables environnement de l'addon)\r\n2. Récupérer les variables d'environnement : \r\n\r\n```json\r\nCELLAR_ADDON_HOST=\"[cellar-c2.services.clever-cloud.com](http://cellar-c2.services.clever-cloud.com/)\"\r\nCELLAR_ADDON_KEY_ID=\"XXX\"\r\nCELLAR_ADDON_KEY_SECRET=\"YYY\"\r\n```\r\n\r\n`CELLAR_ADDON_KEY_ID` et `CELLAR_ADDON_KEY_SECRET` correspondent aux identifiants AWS `AWS_ACCESS_KEY_ID` et `AWS_SECRET_ACCESS_KEY` pour la cli.\r\n\r\n### 1. Créer le bucket en pas-à-pas\r\n\r\nDocumentation clevercloud : [https://www.clever-cloud.com/doc/deploy/addon/cellar/#using-aws-cli](https://www.clever-cloud.com/doc/deploy/addon/cellar/#using-aws-cli)\r\n\r\n### a. Création d'un bucket public en lecture\r\n\r\n **⚠️ mettre un nom de bucket en lowercase ! ⚠️**\r\n\r\n```bash\r\ndocker run \\\r\n  --env AWS_ACCESS_KEY_ID=CELLAR_ADDON_KEY_ID \\\r\n  --env AWS_SECRET_ACCESS_KEY=CELLAR_ADDON_KEY_SECRET \\\r\n  amazon/aws-cli s3api create-bucket \\\r\n  --bucket mon_superbucket \\ \r\n  --acl public-read \\\r\n  --endpoint-url [https://cellar-c2.services.clever-cloud.com](https://cellar-c2.services.clever-cloud.com/)\r\n```\r\n\r\nPour plus d'informations sur les options possibles de l'api s3 : [https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-apicommands.html](https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-apicommands.html) [https://docs.aws.amazon.com/AmazonS3/latest/userguide/creating-buckets-s3.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/creating-buckets-s3.html)\r\n\r\n### b. Uploader un fichier de test en cli\r\n\r\n- Placer vous dans un répertoire avec l’image que vous souhaitez uploader. Par exemple le fichier `cats.png`. (en faisant `ls` dans le répertoire on doit le voir)\r\n- Lancer la commande suivante :\r\n    \r\n    ```bash\r\n    docker run \\ \r\n    --mount type=bind,source=\"$(pwd)\"/cats.png,target=/cats.png \\\r\n    --env AWS_ACCESS_KEY_ID=CELLAR_ADDON_KEY_ID \\\r\n    --env AWS_SECRET_ACCESS_KEY=CELLAR_ADDON_KEY_SECRET \\\r\n    amazon/aws-cli s3api put-object \\\r\n    --key cats.png \\\r\n    --body ../cats.png \\\r\n    --bucket mon_superbucket \\\r\n    --endpoint-url https://cellar-c2.services.clever-cloud.com\r\n    ```\r\n    \r\n    Explication des arguments :\r\n    \r\n    ```bash\r\n    # arguments docker\r\n    --mount type=bind,source=\"$(pwd)\"/cats.png,target=/cats.png => Lie un fichier local sur le conteneur.\r\n    \r\n    # arguments aws s3api put-object\r\n    --key cats.png => chemin absolu du fichier sur le bucket \r\n    --body ../cats.png => chemin relatif du contenu du fichier en local (../cats.png sur le conteneur)\r\n    --bucket mon_superbucket => identifiant du bucket\r\n    ```\r\n    \r\n\r\n- Format de réponse (une réponse indique un succès) :\r\n    \r\n    ![s3api_putobject_response.png](Tutoriel%20Storage%20S3%20sur%20Clevercloud%20(avec%20docker)%2069441023853044deb9226465cc21941a/s3api_putobject_response.png)\r\n    \r\n\r\n### c. U**rl d’accès des fichiers**\r\n\r\nLes fichiers sont disponibles sur https://<nom_du_bucket>.cellar-c2.services.clever-cloud.com/<chemin_du_fichier>\r\n\r\neg: pour les commandes précédentes: `https://mon_superbucket.cellar-c2.services.clever-cloud.com/cats.png`",
  "descriptionFooter": "Hello footer",
  "sousTitreService": "Fait pour les PMs par des devs sympas",
  "liensEntête": [
    {
      "titre": "Header link",
      "url": "/nav"
    }
  ],
  "menu": [
    {
      "titre": "Menu link",
      "url": "http://www.example.com"
    }
  ],
  "liensFooter": [
    {
      "titre": "Footer link",
      "url": "/about"
    }
  ]
}